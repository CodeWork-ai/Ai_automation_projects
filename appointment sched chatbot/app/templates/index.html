<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Scheduling System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .navbar-brand {
            font-weight: 600;
        }
        .nav-link.active {
            border-bottom: 2px solid white;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,.05);
            margin-bottom: 25px;
        }
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: #3a5a8a;
            border-color: #3a5a8a;
        }
        .slot {
            padding: 10px 15px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s;
        }
        .slot:hover {
            background-color: #e9ecef;
        }
        .slot.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .appointment-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .appointment-item:last-child {
            border-bottom: none;
        }
        .appointment-info {
            flex-grow: 1;
        }
        .appointment-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .appointment-details {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }
        .appointment-actions {
            display: flex;
            gap: 10px;
        }
        .chat-container {
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message-content {
            max-width: 70%;
            padding: 12px 15px;
            border-radius: 18px;
            white-space: pre-line;
            word-wrap: break-word;
        }
        .message.bot .message-content {
            background-color: #e9ecef;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        .message.user .message-content {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .notification.success {
            background-color: var(--success-color);
        }
        .notification.error {
            background-color: var(--danger-color);
        }
        .notification.warning {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }
        .notification.info {
            background-color: var(--primary-color);
        }
        .close-notification {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 18px;
            margin-left: 10px;
        }
        .page-section {
            display: none;
        }
        .page-section.active {
            display: block;
        }
        .input-error {
            border-color: var(--danger-color);
        }
        .error-message {
            color: var(--danger-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .modal-header {
            background-color: var(--primary-color);
            color: white;
        }
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }
        .typing-indicator {
            display: flex;
            padding: 10px 15px;
            background-color: #e9ecef;
            border-radius: 18px;
            width: fit-content;
            margin-bottom: 15px;
        }
        .typing-indicator span {
            height: 10px;
            width: 10px;
            background-color: #6c757d;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        .sms-status {
            font-size: 0.85rem;
            color: var(--secondary-color);
            margin-top: 5px;
            font-style: italic;
        }
        .chatbot-help {
            background-color: #e3f2fd;
            border-left: 4px solid var(--primary-color);
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .sms-indicator {
            display: inline-block;
            margin-left: 5px;
            font-size: 0.8rem;
        }
        .sms-indicator.sent {
            color: var(--success-color);
        }
        .sms-indicator.test {
            color: var(--warning-color);
        }
        .sms-indicator.failed {
            color: var(--danger-color);
        }
        .test-sms-card {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
        }
        .test-sms-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .test-sms-result.success {
            background-color: rgba(40, 167, 69, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }
        .test-sms-result.error {
            background-color: rgba(220, 53, 69, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }
        .debug-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .debug-log {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        .debug-log:last-child {
            border-bottom: none;
        }
        .debug-log.error {
            color: var(--danger-color);
        }
        .debug-log.success {
            color: var(--success-color);
        }
        .debug-log.info {
            color: var(--primary-color);
        }
        .chatbot-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .chatbot-appointment-list {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        .chatbot-appointment-item {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chatbot-appointment-item:last-child {
            border-bottom: none;
        }
        .chatbot-appointment-number {
            background-color: var(--primary-color);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .chatbot-appointment-info {
            flex-grow: 1;
            margin-left: 10px;
        }
        .chatbot-appointment-actions {
            display: flex;
            gap: 5px;
        }
        .chatbot-appointment-actions button {
            padding: 2px 8px;
            font-size: 0.8rem;
        }
        .number-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .number-pad button {
            padding: 15px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .quick-action-btn {
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 20px;
        }
        .chatbot-slot-selection {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        .chatbot-slot-item {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chatbot-slot-item:hover {
            background-color: #e9ecef;
        }
        .chatbot-slot-item:last-child {
            border-bottom: none;
        }
        .chatbot-slot-item.selected {
            background-color: #e3f2fd;
            border-left: 3px solid var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-calendar-check me-2"></i>Appointment Scheduler
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-page="appointments">Appointments</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="chatbot">Chatbot Assistant</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <!-- Appointments Page -->
        <div id="appointments-page" class="page-section active">
            <div class="row">
                <!-- Booking Form -->
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Book New Appointment</h5>
                        </div>
                        <div class="card-body">
                            <form id="appointment-form">
                                <div class="mb-3">
                                    <label for="patient-name" class="form-label">Patient Name</label>
                                    <input type="text" class="form-control" id="patient-name" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="patient-contact" class="form-label">Contact Information</label>
                                    <input type="text" class="form-control" id="patient-contact" placeholder="Phone number or email" value="+919551382296" required>
                                    <div id="contact-error" class="error-message d-none">Please enter a valid phone number or email</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="clinic-name" class="form-label">Clinic Name</label>
                                    <select class="form-select" id="clinic-name">
                                        <option value="General Practice">General Practice</option>
                                        <option value="Cardiology">Cardiology</option>
                                        <option value="Dermatology">Dermatology</option>
                                        <option value="Pediatrics">Pediatrics</option>
                                        <option value="Orthopedics">Orthopedics</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Available Time Slots</label>
                                    <div id="slots-container">
                                        <!-- Slots will be loaded here -->
                                    </div>
                                    <input type="hidden" id="selected-slot" required>
                                </div>
                                
                                <button type="submit" class="btn btn-primary w-100">Book Appointment</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Test SMS Card -->
                    <div class="card test-sms-card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">Test SMS</h5>
                        </div>
                        <div class="card-body">
                            <form id="test-sms-form">
                                <div class="mb-3">
                                    <label for="test-phone" class="form-label">Phone Number</label>
                                    <input type="text" class="form-control" id="test-phone" placeholder="Enter phone number" value="+919551382296" required>
                                </div>
                                <div class="mb-3">
                                    <label for="test-message" class="form-label">Message</label>
                                    <textarea class="form-control" id="test-message" rows="3" placeholder="Enter your message" required>This is a test message from the appointment system.</textarea>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Send Test SMS</button>
                            </form>
                            <div id="test-sms-result" class="test-sms-result"></div>
                        </div>
                    </div>
                    
                    <!-- Debug Panel -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">Debug Panel</h5>
                        </div>
                        <div class="card-body">
                            <button id="clear-debug" class="btn btn-sm btn-secondary mb-2">Clear Logs</button>
                            <div id="debug-panel" class="debug-panel">
                                <!-- Debug logs will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Appointments List -->
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Your Appointments</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="search-name" placeholder="Filter by name">
                                </div>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="search-contact" placeholder="Filter by contact">
                                </div>
                            </div>
                            <button id="search-btn" class="btn btn-success mb-3">Search Appointments</button>
                            
                            <div id="appointments-list">
                                <!-- Appointments will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Chatbot Page -->
        <div id="chatbot-page" class="page-section">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Appointment Assistant</h5>
                </div>
                <div class="card-body">
                    <div class="chatbot-help">
                        <i class="fas fa-info-circle me-2"></i>
                        You can book appointments by saying "book appointment" and providing your name and contact information.
                        You can also ask to view or cancel your appointments.
                    </div>
                    <div class="chat-container">
                        <div id="chat-messages" class="chat-messages">
                            <div class="message bot">
                                <div class="message-content">
                                    Hello! I'm your appointment scheduling assistant. How can I help you today?
                                </div>
                            </div>
                        </div>
                        
                        <div id="chatbot-actions" class="chatbot-actions" style="display: none;">
                            <div class="quick-actions">
                                <button class="btn btn-outline-primary quick-action-btn" onclick="sendQuickMessage('book appointment')">
                                    <i class="fas fa-calendar-plus me-1"></i> Book Appointment
                                </button>
                                <button class="btn btn-outline-info quick-action-btn" onclick="sendQuickMessage('view my appointments')">
                                    <i class="fas fa-list me-1"></i> View Appointments
                                </button>
                                <button class="btn btn-outline-warning quick-action-btn" onclick="sendQuickMessage('cancel appointment')">
                                    <i class="fas fa-times-circle me-1"></i> Cancel Appointment
                                </button>
                                <button class="btn btn-outline-success quick-action-btn" onclick="sendQuickMessage('reschedule appointment')">
                                    <i class="fas fa-calendar-alt me-1"></i> Reschedule Appointment
                                </button>
                            </div>
                        </div>
                        
                        <div id="number-pad" class="number-pad" style="display: none;">
                            <button class="btn btn-outline-secondary" onclick="sendNumber('1')">1</button>
                            <button class="btn btn-outline-secondary" onclick="sendNumber('2')">2</button>
                            <button class="btn btn-outline-secondary" onclick="sendNumber('3')">3</button>
                            <button class="btn btn-outline-secondary" onclick="sendNumber('4')">4</button>
                            <button class="btn btn-outline-secondary" onclick="sendNumber('5')">5</button>
                            <button class="btn btn-outline-secondary" onclick="sendNumber('6')">6</button>
                            <button class="btn btn-outline-secondary" onclick="sendNumber('7')">7</button>
                            <button class="btn btn-outline-secondary" onclick="sendNumber('8')">8</button>
                            <button class="btn btn-outline-secondary" onclick="sendNumber('9')">9</button>
                            <button class="btn btn-outline-secondary" onclick="sendNumber('0')">0</button>
                            <button class="btn btn-outline-danger" onclick="sendNumber('clear')">Clear</button>
                        </div>
                        
                        <div class="input-group">
                            <input type="text" id="chat-input" class="form-control" placeholder="Type your message here...">
                            <button id="send-btn" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Reschedule Modal -->
    <div class="modal fade" id="reschedule-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reschedule Appointment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-slot-select" class="form-label">Select New Time Slot</label>
                        <select class="form-select" id="new-slot-select">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-reschedule">Reschedule</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // DOM Elements
        const navLinks = document.querySelectorAll('.nav-link');
        const pageSections = document.querySelectorAll('.page-section');
        const appointmentForm = document.getElementById('appointment-form');
        const patientContactInput = document.getElementById('patient-contact');
        const contactError = document.getElementById('contact-error');
        const slotsContainer = document.getElementById('slots-container');
        const selectedSlotInput = document.getElementById('selected-slot');
        const appointmentsList = document.getElementById('appointments-list');
        const searchNameInput = document.getElementById('search-name');
        const searchContactInput = document.getElementById('search-contact');
        const searchBtn = document.getElementById('search-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const rescheduleModal = new bootstrap.Modal(document.getElementById('reschedule-modal'));
        const newSlotSelect = document.getElementById('new-slot-select');
        const confirmRescheduleBtn = document.getElementById('confirm-reschedule');
        // Test SMS elements
        const testSmsForm = document.getElementById('test-sms-form');
        const testPhoneInput = document.getElementById('test-phone');
        const testMessageInput = document.getElementById('test-message');
        const testSmsResult = document.getElementById('test-sms-result');
        // Debug elements
        const debugPanel = document.getElementById('debug-panel');
        const clearDebugBtn = document.getElementById('clear-debug');
        // Chatbot elements
        const chatbotActions = document.getElementById('chatbot-actions');
        const numberPad = document.getElementById('number-pad');
        
        // API Base URL - Updated to use port 8001
        const API_BASE_URL = 'http://127.0.0.1:8001';
        // Current appointment being rescheduled
        let currentAppointmentId = null;
        // Generate a unique session ID for this chat session
        const sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
        // Chatbot state
        let chatbotState = {
            state: 'idle',
            data: {},
            pendingAction: null,
            selectedAppointmentId: null
        };
        
        // Debug logging function
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `debug-log ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            debugPanel.appendChild(logEntry);
            debugPanel.scrollTop = debugPanel.scrollHeight;
            
            // Also log to console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // Clear debug logs
        clearDebugBtn.addEventListener('click', () => {
            debugPanel.innerHTML = '';
            debugLog('Debug logs cleared', 'info');
        });
        
        // Navigation
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPage = link.getAttribute('data-page');
                showPage(targetPage);
                
                // Update active nav link
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });
        
        function showPage(page) {
            pageSections.forEach(section => {
                section.classList.remove('active');
            });
            
            if (page === 'appointments') {
                document.getElementById('appointments-page').classList.add('active');
                loadSlots();
                loadAppointments();
            } else if (page === 'chatbot') {
                document.getElementById('chatbot-page').classList.add('active');
                // Show chatbot actions when switching to chatbot page
                chatbotActions.style.display = 'flex';
            }
        }
        
        // Phone number validation - simplified for testing
        function validateContact(contact) {
            // For testing, accept any non-empty string
            return contact && contact.trim().length > 0;
        }
        
        patientContactInput.addEventListener('input', () => {
            if (validateContact(patientContactInput.value)) {
                patientContactInput.classList.remove('input-error');
                contactError.classList.add('d-none');
            } else {
                patientContactInput.classList.add('input-error');
                contactError.classList.remove('d-none');
            }
        });
        
        // Load available slots
        async function loadSlots() {
            debugLog('Loading available slots...', 'info');
            try {
                const response = await fetch(`${API_BASE_URL}/slots`);
                debugLog(`Slots response status: ${response.status}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                debugLog(`Loaded ${data.slots.length} slots`, 'success');
                
                slotsContainer.innerHTML = '';
                data.slots.forEach(slot => {
                    const slotElement = document.createElement('div');
                    slotElement.classList.add('slot');
                    slotElement.textContent = slot;
                    slotElement.addEventListener('click', () => selectSlot(slot, slotElement));
                    slotsContainer.appendChild(slotElement);
                });
            } catch (error) {
                debugLog(`Error loading slots: ${error.message}`, 'error');
                showNotification('Error loading available slots', 'error');
                console.error('Error loading slots:', error);
            }
        }
        
        // Select a time slot
        function selectSlot(slot, element) {
            document.querySelectorAll('.slot').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedSlotInput.value = slot;
            debugLog(`Selected slot: ${slot}`, 'info');
        }
        
        // Book appointment
        appointmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            debugLog('Attempting to book appointment...', 'info');
            
            // Validate contact information
            if (!validateContact(patientContactInput.value)) {
                debugLog('Contact validation failed', 'error');
                patientContactInput.classList.add('input-error');
                contactError.classList.remove('d-none');
                return;
            }
            
            // Check if a slot is selected
            if (!selectedSlotInput.value) {
                debugLog('No slot selected', 'error');
                showNotification('Please select a time slot', 'warning');
                return;
            }
            
            const appointmentData = {
                patient_name: document.getElementById('patient-name').value || 'Test Patient',
                patient_contact: patientContactInput.value,
                clinic_name: document.getElementById('clinic-name').value || 'General Practice',
                time: selectedSlotInput.value
            };
            
            debugLog(`Sending appointment data: ${JSON.stringify(appointmentData)}`, 'info');
            
            // Show loading state
            const submitBtn = appointmentForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Booking...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appointmentData)
                });
                
                debugLog(`Appointment response status: ${response.status}`, 'info');
                
                if (response.ok) {
                    const appointment = await response.json();
                    debugLog(`Appointment created: ${JSON.stringify(appointment)}`, 'success');
                    
                    let smsStatus = '';
                    if (appointment.sms_sent) {
                        smsStatus = '<span class="sms-indicator sent"><i class="fas fa-check-circle me-1"></i>SMS sent</span>';
                    } else {
                        smsStatus = '<span class="sms-indicator failed"><i class="fas fa-times-circle me-1"></i>SMS failed</span>';
                    }
                    
                    showNotification(`Appointment booked successfully! ${smsStatus}`, 'success');
                    appointmentForm.reset();
                    document.querySelectorAll('.slot').forEach(el => el.classList.remove('selected'));
                    loadSlots();
                    loadAppointments();
                } else {
                    const errorData = await response.json();
                    debugLog(`Error response: ${JSON.stringify(errorData)}`, 'error');
                    showNotification(`Error: ${errorData.detail}`, 'error');
                }
            } catch (error) {
                debugLog(`Fetch error: ${error.message}`, 'error');
                showNotification('Error booking appointment', 'error');
                console.error('Error booking appointment:', error);
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // Load appointments
        async function loadAppointments(name = '', contact = '') {
            debugLog(`Loading appointments (name: ${name}, contact: ${contact})`, 'info');
            try {
                let url = `${API_BASE_URL}/appointments?`;
                if (name) url += `patient_name=${encodeURIComponent(name)}&`;
                if (contact) url += `patient_contact=${encodeURIComponent(contact)}`;
                
                const response = await fetch(url);
                debugLog(`Appointments response status: ${response.status}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const appointments = await response.json();
                debugLog(`Loaded ${appointments.length} appointments`, 'success');
                
                appointmentsList.innerHTML = '';
                
                if (appointments.length === 0) {
                    appointmentsList.innerHTML = '<p class="text-center">No appointments found.</p>';
                    return;
                }
                
                appointments.forEach(appointment => {
                    const appointmentElement = document.createElement('div');
                    appointmentElement.classList.add('appointment-item');
                    
                    const dateObj = new Date(appointment.created_at);
                    const formattedDate = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString();
                    
                    appointmentElement.innerHTML = `
                        <div class="appointment-info">
                            <div class="appointment-name">${appointment.patient_name}</div>
                            <div class="appointment-details">
                                <i class="fas fa-hospital me-1"></i> ${appointment.clinic_name} | 
                                <i class="fas fa-clock me-1"></i> ${appointment.time} | 
                                <i class="fas fa-phone me-1"></i> ${appointment.patient_contact} | 
                                <i class="fas fa-calendar me-1"></i> Booked on ${formattedDate}
                            </div>
                        </div>
                        <div class="appointment-actions">
                            <button class="btn btn-warning btn-sm reschedule-btn" data-id="${appointment.id}" data-time="${appointment.time}">
                                <i class="fas fa-calendar-alt me-1"></i> Reschedule
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="cancelAppointment(${appointment.id})">
                                <i class="fas fa-times me-1"></i> Cancel
                            </button>
                        </div>
                    `;
                    
                    appointmentsList.appendChild(appointmentElement);
                });
                
                // Add event listeners to reschedule buttons
                document.querySelectorAll('.reschedule-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        const time = this.getAttribute('data-time');
                        openRescheduleModal(id, time);
                    });
                });
                
            } catch (error) {
                debugLog(`Error loading appointments: ${error.message}`, 'error');
                showNotification('Error loading appointments', 'error');
                console.error('Error loading appointments:', error);
            }
        }
        
        // Search appointments
        searchBtn.addEventListener('click', () => {
            const name = searchNameInput.value;
            const contact = searchContactInput.value;
            debugLog(`Searching appointments (name: ${name}, contact: ${contact})`, 'info');
            loadAppointments(name, contact);
        });
        
        // Cancel appointment
        async function cancelAppointment(id) {
            debugLog(`Attempting to cancel appointment ${id}`, 'info');
            if (!confirm('Are you sure you want to cancel this appointment?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/appointments/${id}`, {
                    method: 'DELETE'
                });
                
                debugLog(`Cancel response status: ${response.status}`, 'info');
                
                if (response.ok) {
                    const result = await response.json();
                    debugLog(`Cancel result: ${JSON.stringify(result)}`, 'success');
                    
                    let smsStatus = '';
                    if (result.sms_sent) {
                        smsStatus = '<span class="sms-indicator sent"><i class="fas fa-check-circle me-1"></i>SMS sent</span>';
                    } else {
                        smsStatus = '<span class="sms-indicator failed"><i class="fas fa-times-circle me-1"></i>SMS failed</span>';
                    }
                    
                    showNotification("Appointment cancelled successfully,Thankyou!", 'success');
                    loadSlots();
                    loadAppointments(searchNameInput.value, searchContactInput.value);
                } else {
                    const errorData = await response.json();
                    debugLog(`Cancel error: ${JSON.stringify(errorData)}`, 'error');
                    showNotification(`Error: ${errorData.detail}`, 'error');
                }
            } catch (error) {
                debugLog(`Cancel error: ${error.message}`, 'error');
                showNotification('Error cancelling appointment', 'error');
                console.error('Error cancelling appointment:', error);
            }
        }
        
        // Open reschedule modal
        async function openRescheduleModal(id, currentTime) {
            debugLog(`Opening reschedule modal for appointment ${id}`, 'info');
            
            // Ensure id is a valid number
            if (!id || isNaN(id)) {
                debugLog('Invalid appointment ID', 'error');
                showNotification('Invalid appointment ID', 'error');
                return;
            }
            
            currentAppointmentId = id;
            
            try {
                const response = await fetch(`${API_BASE_URL}/slots`);
                debugLog(`Slots response status: ${response.status}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                debugLog(`Loaded ${data.slots.length} slots for reschedule`, 'success');
                
                // Populate the select dropdown with available slots
                newSlotSelect.innerHTML = '';
                data.slots.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot;
                    option.textContent = slot;
                    if (slot === currentTime) {
                        option.selected = true;
                    }
                    newSlotSelect.appendChild(option);
                });
                
                // Show the modal
                rescheduleModal.show();
            } catch (error) {
                debugLog(`Error loading slots for reschedule: ${error.message}`, 'error');
                showNotification('Error loading available slots', 'error');
                console.error('Error loading slots:', error);
            }
        }
        
        // Confirm reschedule
        confirmRescheduleBtn.addEventListener('click', async () => {
            debugLog(`Confirming reschedule for appointment ${currentAppointmentId}`, 'info');
            
            // Validate appointment ID before making the request
            if (!currentAppointmentId || isNaN(currentAppointmentId)) {
                debugLog('Invalid appointment ID for reschedule', 'error');
                showNotification('Invalid appointment ID. Please try again.', 'error');
                rescheduleModal.hide();
                return;
            }
            
            const newTime = newSlotSelect.value;
            rescheduleModal.hide();
            
            try {
                const response = await fetch(`${API_BASE_URL}/appointments/${currentAppointmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ new_time: newTime })
                });
                
                debugLog(`Reschedule response status: ${response.status}`, 'info');
                
                if (response.ok) {
                    const appointment = await response.json();
                    debugLog(`Reschedule result: ${JSON.stringify(appointment)}`, 'success');
                    
                    let smsStatus = '';
                    if (appointment.sms_sent) {
                        smsStatus = '<span class="sms-indicator sent"><i class="fas fa-check-circle me-1"></i>SMS sent</span>';
                    } else {
                        smsStatus = '<span class="sms-indicator failed"><i class="fas fa-times-circle me-1"></i>SMS failed</span>';
                    }
                    
                    showNotification("Appointment rescheduled successfully,Thankyou!", 'success');
                    loadSlots();
                    loadAppointments(searchNameInput.value, searchContactInput.value);
                } else {
                    const errorData = await response.json();
                    debugLog(`Reschedule error: ${JSON.stringify(errorData)}`, 'error');
                    showNotification(`Error: ${errorData.detail}`, 'error');
                }
            } catch (error) {
                debugLog(`Reschedule error: ${error.message}`, 'error');
                showNotification('Error rescheduling appointment', 'error');
                console.error('Error rescheduling appointment:', error);
            } finally {
                currentAppointmentId = null; // Reset the appointment ID
            }
        });
        
        // Test SMS functionality
        testSmsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            debugLog('Testing SMS...', 'info');
            
            const phone = testPhoneInput.value;
            const message = testMessageInput.value;
            
            // Show loading state
            const submitBtn = testSmsForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Sending...';
            submitBtn.disabled = true;
            
            // Reset previous result
            testSmsResult.style.display = 'none';
            testSmsResult.className = 'test-sms-result';
            
            try {
                const response = await fetch(`${API_BASE_URL}/test-send-sms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone_number: phone,
                        message: message
                    })
                });
                
                debugLog(`Test SMS response status: ${response.status}`, 'info');
                
                const data = await response.json();
                debugLog(`Test SMS result: ${JSON.stringify(data)}`, 'info');
                
                if (data.success) {
                    testSmsResult.className = 'test-sms-result success';
                    testSmsResult.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>SMS sent successfully!</strong><br>
                        <small>Phone: ${data.phone_number}</small><br>
                        <small>Message: ${data.message}</small><br>
                        <small>Status: ${data.details}</small>
                    `;
                    showNotification('Test SMS sent successfully!', 'success');
                } else {
                    testSmsResult.className = 'test-sms-result error';
                    testSmsResult.innerHTML = `
                        <i class="fas fa-times-circle me-2"></i>
                        <strong>Failed to send SMS!</strong><br>
                        <small>Error: ${data.details}</small>
                    `;
                    showNotification(`Failed to send test SMS: ${data.details}`, 'error');
                }
                
                testSmsResult.style.display = 'block';
            } catch (error) {
                debugLog(`Test SMS error: ${error.message}`, 'error');
                testSmsResult.className = 'test-sms-result error';
                testSmsResult.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error!</strong><br>
                    <small>${error.message}</small>
                `;
                testSmsResult.style.display = 'block';
                showNotification('Error sending test SMS', 'error');
                console.error('Error sending test SMS:', error);
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // Handle viewing appointments in chat
        async function handleViewAppointments() {
            debugLog('Handling view appointments request', 'info');
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                const response = await fetch(`${API_BASE_URL}/appointments`);
                typingIndicator.remove();
                
                if (response.ok) {
                    const appointments = await response.json();
                    displayAppointmentsInChat(appointments);
                } else {
                    debugLog(`Error fetching appointments: ${response.status}`, 'error');
                    addMessage('Sorry, I couldn\'t retrieve your appointments. Please try again.', 'bot');
                }
            } catch (error) {
                typingIndicator.remove();
                debugLog(`Error fetching appointments: ${error.message}`, 'error');
                addMessage('Sorry, I encountered an error while retrieving your appointments. Please try again.', 'bot');
            }
        }
        
        // Handle cancel appointment in chat
        async function handleCancelAppointment(appointmentId) {
            debugLog(`Handling cancel appointment request for ID: ${appointmentId}`, 'info');
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                const response = await fetch(`${API_BASE_URL}/appointments/${appointmentId}`, {
                    method: 'DELETE'
                });
                
                typingIndicator.remove();
                
                if (response.ok) {
                    const result = await response.json();
                    debugLog(`Cancel result: ${JSON.stringify(result)}`, 'success');
                    
                    let smsStatus = '';
                    if (result.sms_sent) {
                        smsStatus = '<span class="sms-indicator sent"><i class="fas fa-check-circle me-1"></i>SMS sent</span>';
                    } else {
                        smsStatus = '<span class="sms-indicator failed"><i class="fas fa-times-circle me-1"></i>SMS failed</span>';
                    }
                    
                    addMessage("Appointment cancelled successfully,Thankyou!", 'bot');
                    // Reload appointments to update the list
                    loadAppointments();
                } else {
                    const errorData = await response.json();
                    debugLog(`Cancel error: ${JSON.stringify(errorData)}`, 'error');
                    addMessage(`Error: ${errorData.detail}`, 'bot');
                }
            } catch (error) {
                typingIndicator.remove();
                debugLog(`Cancel error: ${error.message}`, 'error');
                addMessage('Sorry, I encountered an error while cancelling your appointment. Please try again.', 'bot');
            }
        }
        
        // Handle reschedule appointment in chat
        async function handleRescheduleAppointment(appointmentId, newTime) {
            debugLog(`Handling reschedule appointment request for ID: ${appointmentId}, new time: ${newTime}`, 'info');
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                const response = await fetch(`${API_BASE_URL}/appointments/${appointmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ new_time: newTime })
                });
                
                typingIndicator.remove();
                
                if (response.ok) {
                    const appointment = await response.json();
                    debugLog(`Reschedule result: ${JSON.stringify(appointment)}`, 'success');
                    
                    let smsStatus = '';
                    if (appointment.sms_sent) {
                        smsStatus = '<span class="sms-indicator sent"><i class="fas fa-check-circle me-1"></i>SMS sent</span>';
                    } else {
                        smsStatus = '<span class="sms-indicator failed"><i class="fas fa-times-circle me-1"></i>SMS failed</span>';
                    }
                    
                    addMessage(`Appointment rescheduled successfully! ${smsStatus}`, 'bot');
                    // Reload appointments to update the list
                    loadAppointments();
                } else {
                    const errorData = await response.json();
                    debugLog(`Reschedule error: ${JSON.stringify(errorData)}`, 'error');
                    addMessage(`Error: ${errorData.detail}`, 'bot');
                }
            } catch (error) {
                typingIndicator.remove();
                debugLog(`Reschedule error: ${error.message}`, 'error');
                addMessage('Sorry, I encountered an error while rescheduling your appointment. Please try again.', 'bot');
            }
        }
        
        // Chatbot functionality
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Quick action buttons
        function sendQuickMessage(message) {
            if (message.toLowerCase().includes('view') && message.toLowerCase().includes('appointment')) {
                handleViewAppointments();
            } else {
                chatInput.value = message;
                sendMessage();
            }
        }
        
        // Number pad buttons
        function sendNumber(number) {
            if (number === 'clear') {
                chatInput.value = '';
            } else {
                chatInput.value += number;
            }
            chatInput.focus();
        }
        
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            debugLog(`Sending chat message: ${message}`, 'info');
            
            // Add user message to chat
            addMessage(message, 'user');
            chatInput.value = '';
            
            // Check if the user wants to view appointments
            if (message.toLowerCase().includes('view') && message.toLowerCase().includes('appointment')) {
                handleViewAppointments();
                return;
            }
            
            // Check if the user wants to cancel an appointment
            if (message.toLowerCase().includes('cancel') && message.toLowerCase().includes('appointment')) {
                chatbotState.pendingAction = 'cancel';
                addMessage('Please select an appointment to cancel:', 'bot');
                handleViewAppointments();
                return;
            }
            
            // Check if the user wants to reschedule an appointment
            if (message.toLowerCase().includes('reschedule') && message.toLowerCase().includes('appointment')) {
                chatbotState.pendingAction = 'reschedule';
                addMessage('Please select an appointment to reschedule:', 'bot');
                handleViewAppointments();
                return;
            }
            
            // Check if the user is confirming an action (cancel or reschedule)
            if (chatbotState.pendingAction && chatbotState.selectedAppointmentId) {
                if (message.toLowerCase().includes('yes') || message.toLowerCase().includes('confirm')) {
                    if (chatbotState.pendingAction === 'cancel') {
                        handleCancelAppointment(chatbotState.selectedAppointmentId);
                    } else if (chatbotState.pendingAction === 'reschedule') {
                        // For reschedule, we need to show available slots
                        showAvailableSlots(chatbotState.selectedAppointmentId);
                    }
                    
                    // Reset state
                    chatbotState.pendingAction = null;
                    chatbotState.selectedAppointmentId = null;
                    numberPad.style.display = 'none';
                } else if (message.toLowerCase().includes('no') || message.toLowerCase().includes('cancel')) {
                    addMessage('Action cancelled. How else can I help you?', 'bot');
                    
                    // Reset state
                    chatbotState.pendingAction = null;
                    chatbotState.selectedAppointmentId = null;
                    numberPad.style.display = 'none';
                }
                return;
            }
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        message: message,
                        session_id: sessionId
                    })
                });
                
                // Remove typing indicator
                typingIndicator.remove();
                
                const data = await response.json();
                debugLog(`Chat response: ${data.response}`, 'info');
                
                // Update chatbot state
                if (data.state) {
                    chatbotState.state = data.state;
                }
                if (data.data) {
                    chatbotState.data = data.data;
                }
                
                // Add the chatbot's response
                addMessage(data.response, 'bot');
                
                // Handle special UI states
                if (data.response.includes('Please enter the number of the appointment')) {
                    // Show number pad for selection
                    numberPad.style.display = 'grid';
                } else {
                    // Hide number pad if it was shown
                    numberPad.style.display = 'none';
                }
            } catch (error) {
                // Remove typing indicator
                typingIndicator.remove();
                
                debugLog(`Chat error: ${error.message}`, 'error');
                showNotification('Error communicating with chatbot', 'error');
                console.error('Chatbot error:', error);
                addMessage('Sorry, I encountered an error. Please try again.', 'bot');
            }
        }
        
        // Show available slots for rescheduling
        async function showAvailableSlots(appointmentId) {
            debugLog(`Showing available slots for appointment ${appointmentId}`, 'info');
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                const response = await fetch(`${API_BASE_URL}/slots`);
                typingIndicator.remove();
                
                if (response.ok) {
                    const data = await response.json();
                    displaySlotsInChat(data.slots, appointmentId);
                } else {
                    debugLog(`Error fetching slots: ${response.status}`, 'error');
                    addMessage('Sorry, I couldn\'t retrieve available slots. Please try again.', 'bot');
                }
            } catch (error) {
                typingIndicator.remove();
                debugLog(`Error fetching slots: ${error.message}`, 'error');
                addMessage('Sorry, I encountered an error while retrieving available slots. Please try again.', 'bot');
            }
        }
        
        function displaySlotsInChat(slots, appointmentId) {
            debugLog(`Displaying slots in chat. Count: ${slots.length}`, 'info');
            
            const slotList = document.createElement('div');
            slotList.className = 'chatbot-slot-selection';
            
            slots.forEach((slot, index) => {
                const slotItem = document.createElement('div');
                slotItem.className = 'chatbot-slot-item';
                slotItem.textContent = slot;
                slotItem.addEventListener('click', () => selectSlotInChat(slot, appointmentId));
                slotList.appendChild(slotItem);
            });
            
            // Add the slot list to the chat
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot';
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.appendChild(document.createTextNode('Please select a new time slot:'));
            contentElement.appendChild(slotList);
            messageElement.appendChild(contentElement);
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function selectSlotInChat(slot, appointmentId) {
            debugLog(`Selected slot: ${slot} for appointment ${appointmentId}`, 'info');
            
            // Highlight selected slot
            document.querySelectorAll('.chatbot-slot-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Handle reschedule
            handleRescheduleAppointment(appointmentId, slot);
        }
        
        function displayAppointmentsInChat(appointments) {
            debugLog(`Displaying appointments in chat. Count: ${appointments.length}`, 'info');
            
            const appointmentList = document.createElement('div');
            appointmentList.className = 'chatbot-appointment-list';
            
            if (appointments.length === 0) {
                // No appointments found
                const noAppointments = document.createElement('div');
                noAppointments.className = 'text-center text-muted p-3';
                noAppointments.textContent = 'No appointments found.';
                appointmentList.appendChild(noAppointments);
            } else {
                appointments.forEach((appointment, index) => {
                    const appointmentItem = document.createElement('div');
                    appointmentItem.className = 'chatbot-appointment-item';
                    
                    const dateObj = new Date(appointment.created_at);
                    const formattedDate = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString();
                    
                    appointmentItem.innerHTML = `
                        <div class="chatbot-appointment-number">${index + 1}</div>
                        <div class="chatbot-appointment-info">
                            <strong>${appointment.patient_name}</strong><br>
                            <small>
                                <i class="fas fa-hospital me-1"></i> ${appointment.clinic_name} | 
                                <i class="fas fa-clock me-1"></i> ${appointment.time} | 
                                <i class="fas fa-calendar me-1"></i> ${formattedDate}
                            </small>
                        </div>
                        <div class="chatbot-appointment-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="selectChatAppointment(${appointment.id})">Select</button>
                        </div>
                    `;
                    
                    appointmentList.appendChild(appointmentItem);
                });
            }
            
            // Add the appointment list to the chat
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot';
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.appendChild(document.createTextNode('Here are your appointments:'));
            contentElement.appendChild(appointmentList);
            messageElement.appendChild(contentElement);
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function selectChatAppointment(appointmentId) {
            debugLog(`Selected appointment ID: ${appointmentId}`, 'info');
            
            // Set the selected appointment ID
            chatbotState.selectedAppointmentId = appointmentId;
            
            // If we have a pending action, ask for confirmation
            if (chatbotState.pendingAction === 'cancel') {
                addMessage('Are you sure you want to cancel this appointment? Please respond with "yes" or "no".', 'bot');
            } else if (chatbotState.pendingAction === 'reschedule') {
                // For reschedule, we need to show available slots
                showAvailableSlots(appointmentId);
            } else {
                // If no pending action, just show the appointment details
                chatInput.value = `I select appointment ${appointmentId}`;
                sendMessage();
            }
            
            numberPad.style.display = 'none';
        }
        
        function addMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender);
            
            const contentElement = document.createElement('div');
            contentElement.classList.add('message-content');
            
            // Format the text to preserve line breaks
            if (text.includes('\n')) {
                const lines = text.split('\n');
                lines.forEach((line, index) => {
                    if (index > 0) {
                        contentElement.appendChild(document.createElement('br'));
                    }
                    contentElement.appendChild(document.createTextNode(line));
                });
            } else {
                contentElement.textContent = text;
            }
            
            messageElement.appendChild(contentElement);
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Notification system
        function showNotification(message, type = 'info') {
            debugLog(`Showing notification: ${message} (${type})`, 'info');
            
            const notification = document.createElement('div');
            notification.classList.add('notification', type);
            
            const icon = document.createElement('i');
            if (type === 'success') {
                icon.classList.add('fas', 'fa-check-circle');
            } else if (type === 'error') {
                icon.classList.add('fas', 'fa-exclamation-circle');
            } else if (type === 'warning') {
                icon.classList.add('fas', 'fa-exclamation-triangle');
            } else {
                icon.classList.add('fas', 'fa-info-circle');
            }
            
            const text = document.createElement('span');
            text.innerHTML = message;
            
            const closeButton = document.createElement('button');
            closeButton.classList.add('close-notification');
            closeButton.innerHTML = '&times;';
            closeButton.addEventListener('click', () => {
                notification.remove();
            });
            
            notification.appendChild(icon);
            notification.appendChild(text);
            notification.appendChild(closeButton);
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('Application initialized', 'success');
            loadSlots();
            loadAppointments();
        });
    </script>
</body>
</html>